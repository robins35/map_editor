!function(t){var e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(s,h,function(e){return t[e]}.bind(null,h));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var s={};i.r(s),i.d(s,"init",function(){return l}),i.d(s,"mouse",function(){return a}),i.d(s,"keysDown",function(){return d}),i.d(s,"controlKeysDown",function(){return c});var h={};i.r(h),i.d(h,"loadAssets",function(){return M}),i.d(h,"getImage",function(){return S}),i.d(h,"imgs",function(){return k});var o={};i.r(o),i.d(o,"AssetManager",function(){return h}),i.d(o,"setState",function(){return Y}),i.d(o,"state",function(){return H}),i.d(o,"sprites",function(){return I}),i.d(o,"uiElements",function(){return V}),i.d(o,"environmentElements",function(){return F}),i.d(o,"canvas",function(){return R}),i.d(o,"ctx",function(){return E}),i.d(o,"events",function(){return W}),i.d(o,"update",function(){return L}),i.d(o,"draw",function(){return X}),i.d(o,"init",function(){return K});class r{constructor(t,e,i,s){r.id=void 0===r.id?1:r.id,this.id=r.id++,this.pos={x:t,y:e},this.width=i,this.height=s,this.canvas=Game.canvas,this.ctx=Game.ctx}maxX(){return this.canvas.width-this.width}maxY(){return this.canvas.height-this.height}move(t,e){this.pos={x:t,y:e}}safeMove(t,e){t>this.maxX()?this.pos.x=this.maxX():this.pos.x=t<0?0:t,e>this.maxY()?this.pos.y=this.maxY():this.pos.y=e<0?0:e}}class n{constructor(){this.list={}}push(t){if(t instanceof Array)for(let e of t)this.push(e);else this.list[t.id]=t}draw(){for(let t of Object.keys(this.list))this.list[t].draw()}update(){for(let t of Object.keys(this.list))void 0!=this.list[t]&&void 0!=this.list[t].update&&this.list[t].update()}clear(){this.list={}}}let a={x:0,y:0,clicked:!1,down:!1,rightClicked:!1,rightDown:!1,dragging:!1,dragStart:null},d={},c={},l=t=>{$(t).on("mousemove",t=>{a.x=t.offsetX,a.y=t.offsetY,a.clicked=1==t.which&&!a.down,a.down=1==t.which,a.rightClicked=3==t.which&&!a.rightDown,a.rightDown=3==t.which,1==t.which&&a.down&&!a.clicked&&0==a.dragging&&(a.dragging=!0,a.dragStart={x:a.x,y:a.y})}),$(t).on("mousedown",t=>{1==t.which?(a.clicked=!a.down,a.down=!0):3==t.which&&(a.rightClicked=!a.rightDown,a.rightDown=!0)}),$(t).on("mouseup",e=>{1==e.which?(a.down=!1,a.clicked=!1,a.dragging&&(a.dragging=!1,a.dragStart=null,$(t).css({cursor:"default"}))):3==e.which&&(a.rightDown=!1,a.rightClicked=!1)}),$(t).on("contextmenu",t=>!1),$(t).on("mouseleave",t=>{a.dragging=!1,a.dragStart=null}),$(document).on("keydown",t=>{if($.isEmptyObject(c))d[t.keyCode]=!0;else if(c[t.keyCode]=!0,82==t.keyCode){if(!t.preventDefault)return!1;t.preventDefault()}17==t.keyCode&&(c=d,d={})}),$(document).on("keyup",t=>{$.isEmptyObject(c)?delete d[t.keyCode]:(delete c[t.keyCode],17==t.keyCode&&(d=c,c={}))})},u=(t,e,i=0,s=!1)=>{let h=s?t.relativePos:t.pos,o=e.x+i>h.x&&e.x-i<h.x+t.width,r=e.y+i>h.y&&e.y-i<h.y+t.height;return o&&r},m=(t,e)=>({x:t.x+e.x,y:t.y+e.y}),g=(t,e)=>({x:t.x-e.x,y:t.y-e.y}),p=(t,e)=>{let i={};for(let s of Object.keys(e))i[s]=e[s]*t;return i},x=(t,e)=>t.x==e.x&&t.y==e.y;class w extends r{constructor(t){let e=w.calculateDimensionAndPosition(t);super(e.x,e.y,e.width,e.height),this.parent=e.parent,this.color=t.color||"#ffffff",this.backgroundColor=t.backgroundColor,this.borderWidth=t.borderWidth||0,this.visible=t.visible||!0,this.children=[];let i=null;if(t.children)for(let e of Object.keys(t.children)){let s=t.children[e][1];s.parent=this,s.previousSibling=i;let h=new t.children[e][0](s);this.children.push(h),i=h}}static pixelDimension(t,e){if("string"==typeof t){let i=t.slice(0,-1);t=e*(parseInt(i)/100)}else void 0===t&&(t=e);return t}static calculateDimensionAndPosition(t){let e,i,s,h,o=t.parent||Game.canvas,r=t.margin||0,n=t.leftMargin||r,a=t.rightMargin||r,d=t.topMargin||r,c=(t.bottomMargin,t.display||"block"),l=t.previousSibling,u=t.position;if(h=w.pixelDimension(t.width,o.width),s=w.pixelDimension(t.height,o.height),u)e=u.x,i=u.y;else{switch(t.alignment){case"center":e=o.pos.x+(o.width/2-h/2);break;case"right":e=o.pos.x+o.width-h-(a||r);break;default:e="block"!=c&&l?l.pos.x+l.width+n:o.pos.x+n}switch(t.verticalAlignment){case"middle":i=o.pos.y+(o.height/2-s/2);break;case"bottom":i=o.pos.y+o.height-s-(d||r);break;default:i="block"==c&&l?l.pos.y+l.height+d:o.pos.y+d}}return{x:e,y:i,width:h,height:s,parent:o}}show(){this.visible=!0}hide(){this.visible=!1}toggle(){this.visible=!this.visible}draw(){if(this.visible){this.borderWidth&&(this.ctx.beginPath(),this.ctx.rect(this.pos.x,this.pos.y,this.width,this.height),this.ctx.lineWidth=this.borderWidth,this.ctx.strokeStyle=this.color,this.ctx.stroke()),this.backgroundColor&&(this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height));for(let t of this.children)t.draw()}}update(){for(let t of this.children)t.update()}}class v extends w{constructor(t){super(t),this.text=t.text,this.clickAction=t.clickAction,this.clicked=!1,this.backgroundColor=t.backgroundColor||"#cc6600",this.hoveredBackgroundColor=t.hoveredBackgroundColor||"#da8e42",this.clickedBackgroundColor=t.clickedBackgroundColor||"#bb4a00",this.fontSize=t.fontSize||24,this.font=this.fontSize+"px "+(t.font||"amatic-bold"),this.textMargin=t.textMargin||3,v.hoveredButtons={},v.clickedButtons={}}draw(){this.ctx.beginPath(),v.hoveredButtons[this.id]?(v.clickedButtons[this.id]?this.ctx.fillStyle=this.clickedBackgroundColor:this.ctx.fillStyle=this.hoveredBackgroundColor,$(this.canvas).css({cursor:"pointer"})):(this.ctx.fillStyle=this.backgroundColor,Object.keys(v.hoveredButtons).length<=0&&$(this.canvas).css({cursor:"default"})),this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height),this.ctx.fillStyle=this.color,this.ctx.font=this.font,this.ctx.textBaseline="top";let t=this.ctx.measureText(this.text),e=this.pos.x+this.width/2-t.width/2,i=this.pos.y+this.height/2-this.fontSize/2-this.textMargin;this.ctx.fillText(this.text,e,i)}update(){u(this,Game.events.mouse)?(v.hoveredButtons[this.id]=!0,Game.events.mouse.clicked?(v.clickedButtons[this.id]=!0,Game.events.mouse.clicked=!1):v.clickedButtons[this.id]&&!Game.events.mouse.down&&(delete v.clickedButtons[this.id],this.clickAction())):v.hoveredButtons[this.id]&&delete v.hoveredButtons[this.id]}}let f={UIElement:w,Button:v,ProgressBar:class extends w{constructor(t){super(t),this.total=t.total,this.progress=0}draw(){this.ctx.beginPath(),this.ctx.rect(this.pos.x,this.pos.y,this.width,this.height),this.ctx.lineWidth=this.borderWidth,this.ctx.strokeStyle=this.color,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.fillStyle=this.color,this.ctx.fillRect(this.pos.x,this.pos.y,this.calculateWidth(),this.height)}calculateWidth(){return this.width*(this.progress/this.total)}},Grid:class extends w{constructor(t){t.children=[];let e=w.pixelDimension(t.height,(t.parent||Game.canvas).height),i=t.rowHeight||parseInt(e/t.rows.length),s=w.pixelDimension(t.width,(t.parent||Game.canvas).width),h=parseInt(s/t.rows[0].length),o=t.rowMargin||0,r=t.columnMargin||0;for(let e of t.rows){let s=0;for(let n of e)s<e.length-1&&(n[1].display="inline"),n[1].height=i,n[1].width=h,n[1].topMargin=o,n[1].bottomMargin=o,n[1].margin=r,t.children.push(n),s++}super(t)}}};var y=0,b=0,k={},P=[],G=function(){return P.length==y+b},T=function(t){var e=new f.ProgressBar({width:"50%",height:20,alignment:"center",verticalAlignment:"middle",total:P.length,backgroundColor:"#ffffff",color:"#ffffff",borderWidth:2});Game.uiElements.push(e),0==P.length&&t();for(var i=0;i<P.length;i++)!function(i){var s,h;let o=i.split("/").slice(-2);s=o[0],h=o[1].split(".").slice(0,-1).join("."),void 0===k[s]&&(k[s]={}),k[s][h]=new Image,k[s][h].addEventListener("load",function(){y++,e.progress++,G()&&t()},!1),k[s][h].addEventListener("error",function(){b++,console.log(`Error loading image ${this.src}`),G()&&t()},!1),k[s][h].src=i}(P[i])},M=function(t){(t=>{$.ajax({dataType:"json",method:"GET",url:"/load_images",error:t=>{console.log(`ERROR: ${t}`)},success:e=>{P=e,T(t)}})})(t)},S=function(t,e){return k[t][e]};let C=void 0,A=void 0;class D{constructor(t,e,i,s,h){D.id=void 0===D.id?1:D.id,this.id=D.id++,this.list=t,this.command=s,this.params=h,this.previous=e,this.next=i}merge(t){this.params=this.params.concat(t)}reverseCommand(){switch(this.command){case"addTile":this.list.map.viewPort.moveToObject(this.params[0].pos),setTimeout(function(){for(let t of this.params)this.list.map.removeTileFromHistory(t)}.bind(this),100);break;case"eraseTile":this.list.map.viewPort.moveToObject(this.params[0].pos),setTimeout(function(){for(let t of this.params)this.list.map.addTileFromHistory(t)}.bind(this),100);break;default:console.error(`Trying to undo unknown command: ${this.command}`)}}applyCommand(){switch(this.command){case"addTile":this.list.map.viewPort.moveToObject(this.params[0].pos),setTimeout(function(){for(let t of this.params)this.list.map.addTileFromHistory(t)}.bind(this),100);break;case"eraseTile":this.list.map.viewPort.moveToObject(this.params[0].pos),setTimeout(function(){for(let t of this.params)this.list.map.removeTileFromHistory(t)}.bind(this),100);break;default:console.error(`Trying to redo unknown command: ${this.command}`)}}}class j{constructor(t){this.map=t,this.head=null,this.tail=null,this.current=null,this.length=0}print(){let t=this.head,e="";for(;t;)t.id==this.head.id?e+="HEAD":this.current&&t.id==this.current.id?e+="CURRENT":t.id==this.tail.id?e+="TAIL":e+=t.id,e+="-"+t.params.length,t.next&&(e+=" --\x3e "),t=t.next;console.log(e)}push(t,e){let i=new D(this,this.current,null,t,e);this.head||(this.head=i),this.current&&(this.current.next=i),this.current=i,this.tail=this.current,this.length>40?this.head=this.head.next:this.length++}merge(t){this.current&&this.current.merge(t)}undo(){this.current&&(this.current.reverseCommand(),this.current=this.current.previous,this.length--)}redo(){this.current?this.current.next&&(this.current=this.current.next,this.current.applyCommand(),this.length++):this.head&&(this.current=this.head,this.current.applyCommand(),this.length=1)}}class O extends r{constructor(t,e,i,s){super(t,e,s.width,s.height),this.key=i,this.img=s}}let z=void 0;class B extends f.UIElement{constructor(t){super(t),this.map=t.map}static saveMap(){let t=this;for(;void 0===t.map;)t=t.parent;t.map.save()}static loadMainMenu(){Game.setState("load_main_menu")}}let _=()=>{Game.ctx;let t=Game.canvas,e=new class{constructor(t,e,i){this.id="map",this.width=Math.trunc(t/i)*i,this.height=Math.trunc(e/i)*i,this.textureSize=i,this.columns=this.width/i,this.rows=this.height/i,this.viewPort=null,this.map=[],this.layout=[];for(let t=0;t<this.columns;t++)this.map[t]=[],this.layout[t]=[];this.commandHistory=new j(this)}save(){this.serialize(),$.ajax({method:"POST",url:"/maps",data:{layout:JSON.stringify(this.layout)},error:t=>{console.log(`ERROR: response text: ${t.responseText}, status: ${t.status}`)},success:t=>{console.log("SUCCESSFULLY SAVED MAP")}})}serialize(){for(let t=0;t<this.columns;t++)for(let e=0;e<this.rows;e++){let i=this.map[t][e];this.layout[t][e]=i?i.key:null}}calculateAbsolutePosition(t){if(this.viewPort){let s=Game.canvas.width-this.viewPort.width;var e=this.viewPort.pos.x+(t.x-s),i=this.viewPort.pos.y+t.y}else e=t.x,i=t.y;return[e,i]}xyToColRow(t){return[Math.trunc(t.x/this.textureSize),Math.trunc(t.y/this.textureSize)]}addTile(t,e){let[i,s]=this.calculateAbsolutePosition(t.pos),[h,o]=this.xyToColRow({x:i,y:s}),r=new O(i,s,t.key,t.img);this.map[h][o]=r,e&&"addTile"==this.commandHistory.current.command?this.commandHistory.merge([r]):this.commandHistory.push("addTile",[r])}addTileFromHistory(t){let[e,i]=this.xyToColRow({x:t.pos.x,y:t.pos.y});this.map[e][i]=t}removeTile(t,e){let[i,s]=this.calculateAbsolutePosition(t),[h,o]=this.xyToColRow({x:i,y:s}),r=this.map[h][o];return void 0!==r&&(this.map[h][o]=void 0,e&&"eraseTile"==this.commandHistory.current.command?this.commandHistory.merge([r]):this.commandHistory.push("eraseTile",[r]),!0)}removeTileFromHistory(t){let e=Math.trunc(t.pos.x/t.width),i=Math.trunc(t.pos.y/t.height);this.map[e][i]=void 0}draw(){var t,e;if(this.viewPort)var i=(t=Math.trunc(this.viewPort.pos.x/this.textureSize))+Math.trunc(this.viewPort.width/this.textureSize),s=(e=Math.trunc(this.viewPort.pos.y/this.textureSize))+Math.trunc(this.viewPort.height/this.textureSize);else i=(t=0)+Math.trunc(Game.canvas.width/this.textureSize),s=(e=0)+Math.trunc(Game.canvas.height/this.textureSize);for(let h=t;h<=i;h++)for(let t=e;t<=s;t++){if(!this.map[h]||!this.map[h][t])continue;let e=this.map[h][t];if(void 0===e)continue;let i={x:h*this.textureSize,y:t*this.textureSize},s=g(i,this.viewPort.pos),o=m(s,{x:Game.canvas.width-this.viewPort.width,y:0});Game.ctx.drawImage(e.img,o.x,o.y,e.width,e.height)}}}(2*t.width,2*t.height,32),i=t.width-t.width/5,s=t.height-t.height/5;z=new class extends r{constructor(t,e,i){super(0,0,t,e),this.relativePos={x:Game.canvas.width-t,y:0},this.speed=2,this.positionAtDragStart=null,this.map=i,this.map.viewPort=this}maxX(){return this.map.width-this.width}maxY(){return this.map.height-this.height}moveToObject(t){if(!u(this,t)){let e=t.x-this.width/2,i=t.y-this.height/2;this.safeMove(e,i)}}update(){if(Game.events.keysDown[37]&&this.safeMove(this.pos.x-this.speed,this.pos.y),Game.events.keysDown[38]&&this.safeMove(this.pos.x,this.pos.y-this.speed),Game.events.keysDown[39]&&this.safeMove(this.pos.x+this.speed,this.pos.y),Game.events.keysDown[40]&&this.safeMove(this.pos.x,this.pos.y+this.speed),"map_editor"==Game.state&&Game.events.mouse.dragging){let t=Game.events.mouse.dragStart;if(u(this,t,0,!0)){null===this.positionAtDragStart&&(this.positionAtDragStart=Object.assign({},this.pos),$(Game.canvas).css({cursor:"move"}));let t=Game.events.mouse.dragStart,e={x:Game.events.mouse.x,y:Game.events.mouse.y},i=g(t,e),s=m(this.positionAtDragStart,i);this.safeMove(s.x,s.y)}}else this.positionAtDragStart=null}}(i,s,e);let h=new class extends f.UIElement{constructor(t){super(t),this.textures=t.textures,this.selectedTexture=null,this.textureWidth=this.textures[Object.keys(this.textures)[0]].width,this.setupMenuProperties(),this.texturesPerPage=this.textureColumnCount*this.textureRowCount,this.initTextureObjects(),this.totalPages=this.textureObjects.length,this.page=0,this.setupIcons()}setupMenuProperties(){this.imagePadding=5;let t=this.width-120;this.textureColumnCount=Math.trunc(t/(this.textureWidth+this.imagePadding));let e=this.textureColumnCount*(this.textureWidth+this.imagePadding)-this.imagePadding,i=this.height-2*this.imagePadding;this.textureRowCount=Math.trunc(i/(this.textureWidth+this.imagePadding));let s=this.textureRowCount*(this.textureWidth+this.imagePadding)-this.imagePadding;this.rightPadding=(this.width-e)/3,this.leftPadding=2*this.rightPadding,this.topBottomPadding=(this.height-s)/2}setupIcons(){let t=Game.AssetManager.imgs.icons;this.icons={};let e=t.left_arrow;e.pos={x:this.imagePadding,y:this.pos.y+this.height/2-e.height/2},e.clickAction=this.previousPage.bind(this),this.page<=0&&(e.hidden=!0),this.icons.left_arrow=e,(e=t.right_arrow).pos={x:this.width-e.width-this.imagePadding,y:this.pos.y+this.height/2-e.height/2},e.clickAction=this.nextPage.bind(this),this.page>=this.totalPages-1&&(e.hidden=!0),this.icons.right_arrow=e,e=t.eraser;let i=this.rightPadding-this.imagePadding;e.pos={x:i,y:this.pos.y+this.height/2-e.height/2},e.clickAction=this.setErase.bind(this),this.icons.eraser=e}initTextureObjects(){let t=this.pos.x+this.leftPadding,e=this.pos.y+this.topBottomPadding,i=0,s=0,h=Object.keys(this.textures),o=0;this.textureObjects=[[]];for(let r of h){let h=new O(t,e,r,this.textures[r]);this.textureObjects[o].push(h),s++,t+=h.width+this.imagePadding,s>=this.textureColumnCount&&(t=this.pos.x+this.leftPadding,e+=h.height+this.imagePadding,s=0,++i>=this.textureRowCount&&(e=this.pos.y+this.topBottomPadding,i=0,o++,this.textureObjects[o]=[]))}}updateArrowIcons(){this.page==this.totalPages-1?this.icons.right_arrow.hidden=!0:this.icons.right_arrow.hidden=!1,0==this.page?this.icons.left_arrow.hidden=!0:this.icons.left_arrow.hidden=!1}nextPage(){this.page>=this.totalPages-1||(this.page++,this.updateArrowIcons())}previousPage(){this.page<=0||(this.page--,this.updateArrowIcons())}setErase(){this.selectedTexture="eraser"}draw(){this.ctx.beginPath(),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height);for(let t of this.textureObjects[this.page])this.ctx.drawImage(t.img,t.pos.x,t.pos.y,t.width,t.height),this.selectedTexture&&this.selectedTexture.id==t.id&&(this.ctx.lineWidth=3,this.ctx.strokeStyle="#00ff00",this.ctx.strokeRect(t.pos.x,t.pos.y,t.width,t.height)),t.hovering&&(!this.selectedTexture||this.selectedTexture&&this.selectedTexture.id!=t.id)&&(this.ctx.lineWidth=2,this.ctx.strokeStyle="#90c3d4",this.ctx.strokeRect(t.pos.x,t.pos.y,t.width,t.height));for(let t of Object.keys(this.icons)){let e=this.icons[t];e.hidden||this.ctx.drawImage(e,e.pos.x,e.pos.y,e.width,e.height)}}update(){if(u(this,Game.events.mouse)){for(let t of this.textureObjects[this.page])u(t,Game.events.mouse)?(t.hovering=!0,Game.events.mouse.clicked&&(this.selectedTexture=t)):t.hovering=!1;if(Game.events.mouse.clicked){Game.events.mouse.clicked=!1;for(let t of Object.keys(this.icons)){let e=this.icons[t];!e.hidden&&u(e,Game.events.mouse)&&e.clickAction()}}}}}({height:Game.canvas.height-z.height,verticalAlignment:"bottom",backgroundColor:"#2a1d16",textures:Game.AssetManager.imgs.textures}),o=new B({map:e,backgroundColor:"#dbcdae",color:"#00ff00",width:Game.canvas.width-z.width,height:z.height,borderWidth:2,alignment:"left",verticalAlignment:"top",children:[[f.Grid,{height:"40%",width:"80%",rowHeight:30,rowMargin:10,alignment:"center",verticalAlignment:"middle",rows:[[[f.Button,{text:"Save Map",clickAction:B.saveMap}]],[[f.Button,{text:"Main Menu",clickAction:B.loadMainMenu}]],[[f.Button,{text:"Test Button"}]]]}]]}),n=new class extends r{constructor(t,e,i){let s=e.width,h=t.height/t.width*s;super(0,0,e.width,h),this.scale=s/t.width,this.inverseScale=1/this.scale,this.map=t,this.container=e,this.viewPort=i,this.miniViewPort=this.initMiniViewPort(),this.backgroundColor="#222222",this.canvas=Game.canvas,this.ctx=Game.ctx}initMiniViewPort(){let t={width:this.viewPort.width,height:this.viewPort.height},e=p(this.scale,t),i=p(this.scale,this.viewPort.pos);return{width:e.width,height:e.height,pos:i,color:"#ffffff"}}updateMiniViewPort(){if(u(this,Game.events.mouse)&&Game.events.mouse.down){let t=(Game.events.mouse.x-this.miniViewPort.width/2)*this.inverseScale,e=(Game.events.mouse.y-this.miniViewPort.height/2)*this.inverseScale;this.viewPort.safeMove(t,e)}let t=p(this.scale,this.viewPort.pos);this.miniViewPort.pos=t}scaledTextureDetails(t){return{pos:p(this.scale,t.pos),width:t.width*this.scale,height:t.height*this.scale}}draw(){this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(this.pos.x,this.pos.y,this.width,this.height),Math.trunc(this.map.width%this.map.textureSize),Math.trunc(this.map.height%this.map.textureSize);for(let t of this.map.map)for(let e of t){if(void 0===e)continue;let t=this.scaledTextureDetails(e);this.ctx.drawImage(e.img,t.pos.x,t.pos.y,t.width,t.height)}this.ctx.strokeStyle=this.miniViewPort.color,this.ctx.lineWidth=1,this.ctx.strokeRect(this.miniViewPort.pos.x,this.miniViewPort.pos.y,this.miniViewPort.width,this.miniViewPort.height)}update(){this.updateMiniViewPort()}}(e,o,z),a=new class extends r{constructor(t,e,i,s,h=32){super(s.width,0,Game.canvas.width-s.width-Game.canvas.width%h,i.pos.y-i.pos.y%h),this.drawWidth=this.canvas.width-s.width,this.drawHeight=i.pos.y,this.drawX=s.width,this.drawY=0,this.size=h,this.color="#cccccc",this.map=t,this.viewPort=e,this.textureMenu=i,this.sideMenu=s,this.texturePreview=null,this.lastTexturePlacedAt=null,this.texturePreviewAlpha=.3,this.undoing=!1,this.redoing=!1,this.addToLastCommand=!1}resetDimensions(){let t=this.canvas.width-this.pos.x;this.width=t-t%this.size;let e=this.textureMenu.pos.y-this.pos.y;this.height=e-e%this.size}draw(){this.ctx.beginPath();for(let t=this.pos.x+.5;t<=this.drawWidth+this.drawX;t+=this.size)this.ctx.moveTo(t,this.drawY),this.ctx.lineTo(t,this.drawHeight);for(let t=this.pos.y+.5;t<=this.drawHeight;t+=this.size)this.ctx.moveTo(this.drawX,t),this.ctx.lineTo(this.drawWidth+this.drawX,t);if(this.ctx.strokeStyle=this.color,this.ctx.lineWidth=1,this.ctx.stroke(),this.texturePreview&&!this.viewPort.positionAtDragStart){this.ctx.save(),this.ctx.globalAlpha=this.texturePreviewAlpha;let t=this.texturePreview;this.ctx.drawImage(t.img,t.pos.x,t.pos.y,t.width,t.height),this.ctx.restore()}}update(){let t=this.viewPort.pos.x%this.size,e=this.viewPort.pos.y%this.size,i=this.sideMenu.width+(t?this.size-t:0),s=e?this.size-e:0;if(this.move(i,s),this.resetDimensions(),this.undoing||!Game.events.controlKeysDown[90]&&!Game.events.keysDown[85]?!this.undoing||Game.events.controlKeysDown[90]||Game.events.keysDown[85]||(this.undoing=!1):(this.undoing=!0,this.map.commandHistory.undo()),this.redoing||!Game.events.controlKeysDown[82]&&!Game.events.controlKeysDown[89]?!this.redoing||Game.events.controlKeysDown[82]||Game.events.controlKeysDown[89]||(this.redoing=!1):(this.redoing=!0,this.map.commandHistory.redo()),this.textureMenu.selectedTexture)if(u(this,Game.events.mouse)){let t=Math.trunc((Game.events.mouse.x-this.pos.x)/this.size),e=Math.trunc((Game.events.mouse.y-this.pos.y)/this.size),i=this.pos.x+t*this.size,s=this.pos.y+e*this.size;"eraser"!=this.textureMenu.selectedTexture&&(this.texturePreview?this.texturePreview.pos={x:i,y:s}:this.texturePreview=new O(i,s,this.textureMenu.selectedTexture.key,this.textureMenu.selectedTexture.img)),Game.events.mouse.rightDown?this.lastTexturePlacedAt&&x({x:i,y:s},this.lastTexturePlacedAt)||(this.lastTexturePlacedAt={x:i,y:s},"eraser"==this.textureMenu.selectedTexture?this.map.removeTile({x:i,y:s},this.addToLastCommand)&&(this.addToLastCommand=!0):(this.map.addTile(this.texturePreview,this.addToLastCommand),this.addToLastCommand=!0)):this.lastTexturePlacedAt&&!Game.events.mouse.rightDown&&(this.lastTexturePlacedAt=null,this.addToLastCommand=!1)}else this.texturePreview=null}}(e,z,h,o);Game.uiElements.push([h,o,n]),Game.environmentElements.push([e,a])};let R=void 0,E=void 0,W=s,H="begin",I=new n,V=new n,F=new n,L=()=>{switch(H){case"begin":H="idle",M(()=>{H="load_main_menu",console.log("Loaded assets"),V.clear()});break;case"load_main_menu":H="main_menu",(()=>{C=Game.canvas,A=Game.ctx;let t=new f.Grid({width:"20%",height:"50%",rowHeight:30,margin:30,rowMargin:10,verticalAlignment:"bottom",rows:[[[f.Button,{text:"Map Editor",clickAction:()=>{Game.uiElements.clear(),Game.setState("load_map_editor")}}]],[[f.Button,{text:"Settings",clickAction:()=>{console.log("Stubbing settings load action")}}]]]});Game.sprites.clear(),Game.environmentElements.clear(),Game.uiElements.clear(),Game.uiElements.push(t)})();break;case"main_menu":V.update();break;case"load_map_editor":H="map_editor",_();break;case"map_editor":z.update(),I.update(),V.update(),F.update()}},X=()=>{E.clearRect(0,0,R.width,R.height),I.draw(),F.draw(),V.draw()},Y=t=>{H=t},K=()=>{(R=document.getElementById("map_editor")).pos={x:0,y:0},E=R.getContext("2d"),W.init(R)};window.Game=o;const U=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;$(document).ready(()=>{if(Game.init(),U){let t=()=>{Game.update(),U(t)},e=()=>{Game.draw(),U(e)};t(),e()}else setInterval(Game.update,1e3/60),setInterval(Game.draw,1e3/60)})}]);